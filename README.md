# quay-operator

[![Build Status](https://travis-ci.org/redhat-cop/quay-operator.svg?branch=master)](https://travis-ci.org/redhat-cop/quay-operator) [![Docker Repository on Quay](https://quay.io/repository/redhat-cop/quay-operator/status "Docker Repository on Quay")](https://quay.io/repository/redhat-cop/quay-operator)

Operator to manage the lifecycle of [Quay](https://www.openshift.com/products/quay).

## Overview

This repository contains the functionality to provision a Quay ecosystem. Quay is supported by a number of other components, and thus a CustomResourceDefinition called `QuayEcosystem` is used to define the entire architecture. 

The following components are supported to be maintained by the Operator:

* Quay
* Redis

## Provisioning a Quay Ecosystem

### Deploy the Operator

Quay requires that it be deployed in a namespace called `quay-enterprise`.

```
$ oc new-project quay-enterprise
```

Deploy the cluster resources. Given that a number of elevated permissions are required to resources at a cluster scope the account you are currently logged in must have elevated rights

```
$ oc create -f deploy/crds/cop_v1alpha1_quayecosystem_crd.yaml
$ oc create -f deploy/service_account.yaml
$ oc create -f deploy/cluster_role.yaml
$ oc create -f deploy/cluster_role_binding.yaml
$ oc create -f deploy/role.yaml
$ oc create -f deploy/role_binding.yaml
$ oc create -f deploy/operator.yaml
```


### Deploy a Quay Ecosystem

Create a pull secret to retrieve Quay images from quay.io

```
$ oc create secret generic coreos-pull-secret --from-file=".dockerconfigjson=<location of docker.json file>" --type='kubernetes.io/dockerconfigjson'
```

Create a custom resource to deploy the Quay ecosystem. The following is an example of a `QuayEcosystem` custom resource to support a deployment of the Quay ecosystem

```
apiVersion: cop.redhat.com/v1alpha1
kind: QuayEcosystem
metadata:
  name: example-quayecosystem
spec:
  imagePullSecretName: coreos-pull-secret
```

You can also run the following command to create the `QuayEnterprise` custom resource

```
$ oc create -f deploy/crds/cop_v1alpha1_quayecosystem_cr.yaml
```

#### Persistence Support

MySQL or PostgreSQL can be deployed to provide persistence for quay.

The following QuayEcosystem custom resource can be used to provision Quay along with a backing MySQL database:

```
kind: QuayEcosystem
metadata:
  name: example-quayecosystem
spec:
  imagePullSecretName: coreos-pull-secret
  quay:
    database:
      type: mysql
```

A type of `postgresql` is also available to deploy an instance of PostgreSQL

##### Database Configuration

_Note: The use of databases that are managed as part of the `QuayEcosystem` are intended for development purposes. For production scenarios, it is recommended that database either reside off cluster or managed by a dedicated operator._

Support is available to customize the configuration of the database backing Quay

Underneath the _database_ property, the following options are available:

| Property | Description | 
| --------- | ---------- |
| `image` | Location of the database image |
| `volumeSize` | Size of the volume in Kubernetes capacity units |
| `memory` | Amount of memory in Kubernetes resource units |
| `cpu` | Amount of cpu in Kubernetes resource units |
| `credentialsSecretName` | Name of the secure containing the database name and authentication (see below) |

##### Database Credential

When a database is provisioned, a _secret_ is utilized which contain the database name as well as authentication details. A existing secret can be provided within the `QuayEcosystem` object as shown below:

```
kind: QuayEcosystem
metadata:
  name: example-quayecosystem
spec:
  imagePullSecretName: coreos-pull-secret
  quay:
    database:
      type: mysql
      credentialsSecretName: user-provided-db-secret
```

If the `credentialsSecretName` is not provided, one will be generated by the operator automatically.

The following command can be used to create a secret called _user-provided-db-secret_ for a PostgreSQL database

```
$ oc create secret generic user-provided-db-secret --from-literal=database-password=quayPassword --from-literal=database-username=quay --from-literal=database-name=quay
```

_Note:_ When provisioning a MySQL database, the key `database-root-password` is required (such as `--from-literal=database-root-password=quayAdmin`)` 


##### PostgreSQL Considerations

As of this time, additional steps are required in order to finalize the configurations for PostgreSQL. Please see the [Setting up Quay on OpenShift documentation](https://access.redhat.com/documentation/en-us/red_hat_quay/2.9/html/deploy_red_hat_quay_on_openshift/set_up_red_hat_quay_services) to configure the `pg_trgm` extension.

## Registry Storage

Quay supports a number of registry storage options. One such option (for development environments) is to leverage local storage. To enable the contents of the registry leveraging local storage to be retained beyond the lifespan of a single pod, a PersistentVolume can be utilized.

The following can be added to the _quay_ section of the _QuayEcosystem_ object to enable PersistentVolume support for local storage:

```
quay:
  registryStorage:
    persistentVolume:
      accessModes:
      - ReadWriteOnce
      capacity: 20Gi
```

## Local Development

Execute the following steps to develop the functionality locally. It is recommended that development be done using a cluster with `cluster-admin` permissions. 

Clone the repository, then resolve all depdendencies using `dep`

```
$ dep ensure
```

Using the [operator-sdk](https://github.com/operator-framework/operator-sdk), run the operator locally

```
$ operator-sdk up local --namespace=quay-enterprise
```